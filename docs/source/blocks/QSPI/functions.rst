QSPI 常规命令模式
^^^^^^^^^^^^^^^^^

常规命令模式下，每个命令最多有五个阶段：指令、地址、交替字节、空指令和数据，任一阶段均可跳过，但至少要包含指令、地址、交替字节或数据阶段的其中一个阶段。

.. figure:: ./images/QSPI_Command_Seq.svg
   :name: QSPI_Command_Seq
   :align: center
   :scale: 100%
   
   四线模式下的读命令示例

**指令阶段**

这一阶段，将在 QSPI_CCR [7:0] 寄存器的CODE字段中配置的一条8位指令发送到外部SPI设备，指定待执行操作的类型。

可通过QSPI_CCR[9:8]寄存器中的 IMODE[1:0]字段进行配置一次1位、2位（在双线 SPI 模式中通过 IO0/IO1）、4位（在四线 SPI 模式中通过IO0/IO1/IO2/IO3）的方式接收指令。

**地址阶段**

在地址阶段，待发送的地址字节数在 QSPI_CCR[13:12] 寄存器的 ADSIZE[1:0]
字段中进行配置。

在间接模式和自动轮询模式下，待发送的地址字节在 QSPI\_
ADDR寄存器的ADDRESS[31:0]
中指定。在间接模式下，此寄存器需要在配置命令寄存器之后进行配置（不能之前），且每次传输过程都需要配置。

可通过QSPI_CCR[11:10]寄存器中的ADMODE[1:0]字段进行配置一次发送1位（在单线
SPI 模式中通过
SO）、2位（在双线SPI模式中通过IO0/IO1）或4位（在四线SPI模式中通过
IO0/IO1/IO2/IO3）。

**交替字节阶**

在交替字节阶段，一般用于控制操作模式。待发送的交替字节数在QSPI_CCR[17:16]寄存器的ABSIZE[1:0]字段中进行配置。待发送的字节在
QSPI_ABR 寄存器中指定。

可通过QSPI_CCR[15:14]寄存器中的ABMODE[1:0]字段进行配置一次发送1位（在单线
SPI 模式中通过SO）、2
位（在双线SPI模式中通过IO0/IO1）或4位（在四线SPI模式中通过IO0/IO1/IO2/IO3）。

**空指令周期阶段**

在空指令周期阶段，给定的 0-31
个周期内不发送或接收任何数据，这期间与外部设备没有数据交互，为了等待外部设备准备数据。

这一阶段中给定的周期数在 QSPI_CCR[22:18] 寄存器的DUMMY
[4:0]字段中指定。在SDR模式下，持续时间被指定为一定个数的全时钟周期。

当工作在2线、4线模式下从外部存储器中接收数据时，至少设置一个空指令周期。

**数据阶段**

在数据阶段，可从外部设备接收或向其发送任意数量的字节。

在间接模式和自动轮询模式下，待发送/接收的字节数在
QSPI_SIZE寄存器中指定。 在间接写入模式下，发送的数据必须写入 QSPI_DATA
寄存器。在间接读取模式下，通过读取
QSPI_DATA寄存器获得接收的数据；在自动轮询模式下，包含从设备读取到的最后一个数据。

数据阶段可通过QSPI_CCR[15:14]
寄存器中的ABMODE[1:0]字段进行配置一次发送/接收1位（在单线SPI模式中通过
SO）、2位（在双线SPI模式中通过
IO0/IO1）或4位（在四线SPI模式中通过IO0/IO1/IO2/IO3）。

**nCS和SCK的行为**

默认情况下，nCS 为高电平，取消选择外部设备。nCS
在操作开始前下降，在操作完成 时立即上升。

当CKMODE = 0（“模式 0”，在未进行任何操作时 CLK
保持低电平）时，nCS在操作首次升高 CLK
边沿时的一个CLK周期前降至低电平，在操作最后一次升高CLK 边沿时的一个CLK
周期后升至高电平，如图所示。

.. figure:: ./images/QSPI_nCS_SCLK1.svg
   :name: QSPI_nCS_SCLK1
   :align: center
   :scale: 100%

   nCS和SCLK时序关系图1

当CKMODE = 1（“模式3”，在未进行任何操作时CLK升至高电平，nCS仍在操作首次升高
CLK边沿时的一个CLK周期前降至低电平，在操作最后一次升高CLK边沿时的一个CLK周期后升至高电平，如图所示

.. figure:: ./images/QSPI_nCS_SCLK2.svg
   :name: QSPI_nCS_SCLK2
   :align: center
   :scale: 100%

   nCS和SCLK时序关系图2

当读操作时FIFO处于满状态，或写操作时FIFO处于空状态时，该操作将停止，CLK保持在低电平，如果在操作停止时发生中止，则nCS在请求中止后立即上升，SCLK信号会在一半的SCLK周期之后拉高，如图所示。

.. figure:: ./images/QSPI_nCS_SCLK3.svg
   :name: QSPI_nCS_SCLK3
   :align: center
   :scale: 100%

   nCS和SCLK时序关系图3

QSPI 信号接口协议模式
^^^^^^^^^^^^^^^^^^^^^

**单线SPI模式**

在单线模式下，数据通过SO信号（其I/O与IO0共享）发送。收到的数据通过SI（其I/O与IO1
共享）送达。

通过将QSPI_CCR中的IMODE/ADMODE/ABSIZE/DMODE 字段设置为01，可对不同的命令阶段分别进行配置，以使用此单个位模式。

**双线SPI模式**

在双线模式下，通过IO0/IO1信号同时发送/接收两位。

通过将QSPI_CCR寄存器的IMODE/ADMODE/ABSIZE/DMODE字段设置为10，可对不同的命令阶段分别进行配置，以使用双线SPI模式。

**四线SPI模式**

在四线模式下，通过 IO0/IO1/IO2/IO3信号同时发送/接收四位。

通过将QSPI_CCR寄存器的IMODE/ADMODE/ ABSIZE
/DMODE字段设置为11，可对不同的命令阶段分别进行配置，以使用四线SPI模式。

**SDR模式**

默认情况下，QSPI在单倍数据速率(SDR)模式下工作。

QSPI操作模式
^^^^^^^^^^^^

**间接模式**

通过配置QSPI_CCR[27:26] MODE = 00，则处于间接写入模式，字节在数据阶段中发送到 。通过写入数据寄存器
(QSPI_DATA) 的方式提供数据。若FMODE = 01，则 QSPI处于间接读取模式，在数据阶段中接收字节。通过读取数据寄存器
(QSPI_DATA)来获取数据。 读取/ 写入的字节数在数据长度寄存器 (QSPI_SIZ E)中指定。如果 QSPI_SIZE =0xFFFF_FFFF（全为“1”），则数据长度视为未定义，QSPI将继续传输数据，直到到达（由QSPI_DCR[20:16]FSIZE
定义的）FLASH的结尾。

如果不传输任何字节，DMODE (QSPI_CCR[25:24]) 应设置为 00。

**常规模式下触发命令序列**

命令序列在根据通信需求配置好最后信息之后立即开始。

当没有地址并且没有数据时，在访问QSPI_CODE寄存器之后立即开始命令序列。

当存在地址但没有数据时，在访问QSPI_ADDR寄存器之后立即开始命令序列。

当在间接模式写操作时需要地址并且有数据，在访问QSPI_DATA寄存器之后立即开始命令序列。

如果命令启动，BUSY位置1。

**FIFO和标志控制**

在间接模式中，数据将通过QSPI内部的一个16字节FIFO。FLEVEL
(QSPI_SR[12:8]) 指示 FIFO目前保存了多少字节。

在间接写入模式下 (MODE =
00)，写入QSPI_DATA时，将在FIFO中加入数据。字写入将在FIFO中增加4个字节，半字写入增加2个字节，而字节写入仅增加1个字节。如果固件在
FIFO中加入的数据过多（超过 SIZE[31:0]
指示的值），将在写入操作结束（TCF置1）时从FIFO中清除超出的字节。

**状态轮询模式**

在自动轮询模式下，QSPI
周期性启动命令以读取一定数量的状态字节，每个帧读取的最大数据量是4
字节。自动轮询间隔周期（按照SCLK周期计数）在QSPI_PIR寄存器中设定。

在自动轮询模式下，MASK[31:0] (QSPI_PSMKR) 的内容用于屏蔽数据。如果
MASK[n] = 0，则屏蔽结果的位n，从而不考虑该位。如果MASK[n] = 1
并且位[n]的内容与 MATCH[n] (QSPI_PSMAR) 相同，说明存在位n匹配。

**内存映射模式**

在配置为内存映射模式时，外部SPI器件被视为是内部存储器。

即使 FLASH 容量更大，寻址空间也无法超过128MB。
如果访问的地址超出FSIZE定义的范围但仍在128MB
范围内，则根据FLASH特性处理，一般为回卷读取。内存映射模式下每一个AHB读请求，都会完整执行一次符合QSPI接口协议读请求命令。

QSPI延迟数据采样
^^^^^^^^^^^^^^^^

默认情况下，QSPI在FLASH驱动信号后过半个CLK周期才对FLASH驱动的数据采样。在外部信号延迟时，有利于推迟数据采样。
使用SSHIFT位（QSPI_CR[4] ），可将数据采样移位半个QSPI CLK周期；使用CYCLE位（QSPI_SSHIFT [0:3]），配置的是系统时钟CLK下延迟采样的周期数，延时采样开关开启时（SSHIFT=1），在这之后再延时采样半SCLK周期。即实际的延迟采样时间是QSPI_SSHIFT[CYCLE]与QSPI_CR[SSHIFT]设定延时的累加。


