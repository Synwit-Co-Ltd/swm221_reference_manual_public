**1.1正交编码器（QEI）**
------------------------

**1.1.1概述**
~~~~~~~~~~~~~

SWM221系列所有型号QEI操作均相同。使用前需使能对应QEI模块时钟。

正交编码器（增量式编码器或光电式编码器）用于检测旋转运动系统的位置和速度，正交编码器可以用于多种电机的闭环控制，诸如开关磁阻（SR）电机和交流感应电机（ACM）等。

**1.1.2特性**
~~~~~~~~~~~~~

-  可编程输入信号毛刺滤波

-  提供脉冲计数和计数方向的正交解码器

-  16位向上/向下计数器

-  计数方向状态

-  ×2和×4两种计数模式

-  索引复位/计数匹配复位模式

-  通用16位计数器（正向计数或反向计数）

-  QEI产生的中断

-  A相和B相输入的交换模式

**1.1.3模块结构框图**
~~~~~~~~~~~~~~~~~~~~~

|image1|

图 6‑23 QEI模块结构框图

**1.1.4功能描述**
~~~~~~~~~~~~~~~~~

**功能说明**
^^^^^^^^^^^^

典型的增量式编码器包括一个放置在电机转动轴上的带有开槽的轮子和一个用于检测开槽的发射/接收装置，通常有三个输出，分别为A相、B相和索引相（INDXE），所提供的信息可被QEI接口解码，用来提供电机的运动信息，包括旋转距离和旋转方向，编码盘的示意图如图
1‑1所示。

|image2|

图 1‑1增量式正交编码盘示意图

**时序说明**
^^^^^^^^^^^^

在正交编码器中A相（QEA）和B相（QEB）的位置关系是唯一的，如果A相超前B相，那么电机的旋转方向被认为是正向，反之则被认为是反向旋转，索引相作为基准来确定电机的绝对位置，电机每旋转一圈产生一个索引相脉冲信号，电机旋转时三个信号的相关时序如图
6‑25所示。

|image3|

图 1‑2三相信号正向/反向旋转时序关系

**正交解码器**
^^^^^^^^^^^^^^

正交解码器的工作过程如图 1‑3和图 1‑4所示：

如图
1‑3中正交解码器工作在x4计数模式下，在QEA、QEB的上升沿和下降沿处都会计数。

计数的方向由正反转状态UPDN决定：

-  当UPDN为高电平时，表示电机正转，计数器在每个计数脉冲到来时累加计数结果；

-  当UPDN为低电平时，表示电机反转，计数器在每个计数脉冲到来时递减。

在电机换向旋转时若产生抖动（在图
6‑26中jitter为抖动部分），QEI模块会根据检测到的计数脉冲情况判断是否产生抖动，在电机抖动的情况下，计数器不工作，直到电机恢复稳定状态为止。

|image4|

图 1‑3正交编码器x4计数模式示意图

如图
1‑4所示：正交编码器工作在x2计数模式下，在该模式下，计数脉冲只在QEA的上升沿和下降沿处产生，QEB只被用来判断旋转方向。

|image5|

图 1‑4正交编码器x2计数模式示意图

**计数器复位模式**
^^^^^^^^^^^^^^^^^^

在QEI模块中支持两种复位模式：索引复位和计数匹配复位。

索引复位

索引复位的方式如图
1‑5所示，在INDEX信号到来时，QEI计数器复位，旋转方向不变时计数器每次都将在索引信号的同一位置发生复位，正向旋转和反向旋转时的复位位置相对称，将QEI模块配置在索引复位模式下，QEI模块将会自动检测INDEX信号和电机正转/反转时索引信号的复位位置。

|image6|

图 1‑5 QEI计数器索引复位模式

匹配复位

计数匹配复位发生在计数器的累加值与预置的目标计数值相等时发生。

在电机正向旋转时，计数器的累加值与最大计数值相等时发生复位，复位后计数器的值被置0；

在电机反向旋转时，计数器的累加值在等于零时发生复位，复位后计数器的值被复位为预置的最大计数值，计数匹配复位方式如图
1‑6所示。

|image7|

图 1‑6计数匹配复位模式

**配置方式**
^^^^^^^^^^^^

配置方式如下：

-  通过PORTX_FUNC寄存器将引脚切换为QEI对应数字功能，并使能数字输入

-  配置QEI工作模式（X2、X4）、最大计数值、复位源等设置

-  若需要使用中断，使能QEI相应中断

-  启动QEI，开始计数

-  定时读取QEI位置计数器和最大值计数器，从而计算电机的转动方向和速度

**中断配置与清除**
^^^^^^^^^^^^^^^^^^

可通过配置IE寄存器设置QEI模块对应的中断，如需清除相应的中断标志，需在IC寄存器相应位中将中断状态写1清零（R/W1C）。

**1.1.5寄存器映射**
~~~~~~~~~~~~~~~~~~~

.. list-table::
   :widths: 13 8 6 12 33
   :header-rows: 1

   - 

      - 名称
      - 偏移
      - 类型
      - 复位值
      - 描述
   - 

      - QEI BASE：0x40041000
      - 
      - 
      - 
      - 
   - 

      - CR
      - 0x00
      - R/W
      - 0x00
      - 控制/状态寄存器
   - 

      - POSCNT
      - 0x04
      - RO
      - 0x01
      - QEI位置计数器/定时器状态寄存器
   - 

      - MAXCNT
      - 0x08
      - R/W
      - 0x00
      - QEI位置计数器/定时器匹配计数寄存器
   - 

      - IE
      - 0x20
      - R/W
      - 0x00
      - 中断使能寄存器
   - 

      - IM
      - 0x24
      - R/W
      - 0x00
      - 中断状态屏蔽寄存器
   - 

      - IC
      - 0x28
      - R/W
      - 0x00
      - 清除中断状态寄存器
   - 

      - IIF
      - 0x2C
      - R/W
      - 0x00
      - 中断状态寄存器
   - 

      - IFOV
      - 0x30
      - RO
      - 0x00
      - 中断溢出寄存器

**1.1.6寄存器描述**
~~~~~~~~~~~~~~~~~~~

控制/状态寄存器（CR）

.. list-table::
   :widths: 12 9 6 12 33
   :header-rows: 1

   - 

      - 寄存器
      - 偏移
      - 类型
      - 复位值
      - 描述
   - 

      - CR
      - 0x00
      - R/W
      - 0
      - 控制寄存器

.. list-table::
   :widths: 9 9 9 9 9 9 9 9
   :header-rows: 1

   - 

      - **31**
      - **30**
      - **29**
      - **28**
      - **27**
      - **26**
      - **25**
      - **24**
   - 

      - -
      - 
      - 
      - 
      - 
      - 
      - 
      - 
   - 

      - **23**
      - **22**
      - **21**
      - **20**
      - **19**
      - **18**
      - **17**
      - **16**
   - 

      - -
      - 
      - 
      - 
      - 
      - 
      - 
      - 
   - 

      - **15**
      - **14**
      - **13**
      - **12**
      - **11**
      - **10**
      - **9**
      - **8**
   - 

      - -
      - 
      - 
      - 
      - 
      - QEISIDL
      - INDEX
      - UPDN
   - 

      - **7**
      - **6**
      - **5**
      - **4**
      - **3**
      - **2**
      - **1**
      - **0**
   - 

      - QEIM<2>
      - QEIM<1>
      - QEIM<0>
      - SWPAB
      - TQCKPS<1:0>
      - 
      - TQCS
      - QEPEN

.. list-table::
   :widths: 7 15 50
   :header-rows: 1

   - 

      - 位域
      - 名称
      - 描述
   - 

      - 31:11
      - REVERSED
      - -
   - 

      - 10
      - QEISIDL
      - 空闲模式停止位

         1：模块暂停工作

         0：模块继续工作
   - 

      - 9
      - INDEX
      - 索引信号状态位（写无效）

         1：索引引脚为高电平

         0：索引引脚为低电平
   - 

      - 8
      - UPDN
      - 计数方向状态位（仅用于定时器模式）

         1：正向计数

         0：反向计数
   - 

      - 7
      - QEIM<2>
      - 工作模式选择位

         1：QEI解码器模式

         0：定时器模式
   - 

      - 6
      - QEIM<1>
      - 计数器复位模式选择位

         1：索引信号复位

         0：计数匹配复位
   - 

      - 5
      - QEIM<0>
      - QEI计数模式选择位

         1：X4计数模式

         0：X2计数模式
   - 

      - 4
      - SWPAB
      - 

         A. B换向选择位

         1：A、B以换向

         0：A、B未换向
   - 

      - 3：2
      - TQCKPS<1:0>
      - 定时器时钟分频选择位（仅用于定时器模式）

         11: 256分频

         10: 64分频

         01：8分频

         00：不分频
   - 

      - 1
      - TQCS
      - 定时器时钟来源选择位（仅用于定时器模式）

         1：QEA引脚（上升沿）

         0：内部时钟
   - 

      - 0
      - QEPEN
      - QEI模块使能（QEI、定时器功能）

         1：使能

         0：禁能

位置计数器/定时器状态寄存器（POSCNT）

.. list-table::
   :widths: 12 9 6 12 33
   :header-rows: 1

   - 

      - 寄存器
      - 偏移
      - 类型
      - 复位值
      - 描述
   - 

      - POSCNT
      - 0x04
      - R/W
      - 0
      - 位置计数器

.. list-table::
   :widths: 9 9 9 9 9 9 9 9
   :header-rows: 1

   - 

      - **31**
      - **30**
      - **29**
      - **28**
      - **27**
      - **26**
      - **25**
      - **24**
   - 

      - -
      - 
      - 
      - 
      - 
      - 
      - 
      - 
   - 

      - **23**
      - **22**
      - **21**
      - **20**
      - **19**
      - **18**
      - **17**
      - **16**
   - 

      - -
      - 
      - 
      - 
      - 
      - 
      - 
      - 
   - 

      - **15**
      - **14**
      - **13**
      - **12**
      - **11**
      - **10**
      - **9**
      - **8**
   - 

      - POSCNT
      - 
      - 
      - 
      - 
      - 
      - 
      - 
   - 

      - **7**
      - **6**
      - **5**
      - **4**
      - **3**
      - **2**
      - **1**
      - **0**
   - 

      - POSCNT
      - 
      - 
      - 
      - 
      - 
      - 
      - 

.. list-table::
   :widths: 7 15 50
   :header-rows: 1

   - 

      - 位域
      - 名称
      - 描述
   - 

      - 31:16
      - -
      - -
   - 

      - 15:0
      - POSCNT
      - 位置计数器/定时器状态

**位置计数器/定时器匹配计数寄存器（MAXCNT）**
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. list-table::
   :widths: 12 9 6 12 33
   :header-rows: 1

   - 

      - 寄存器
      - 偏移
      - 类型
      - 复位值
      - 描述
   - 

      - MAXCNT
      - 0x08
      - R/W
      - 0
      - 位置计数器/定时器匹配计数值

.. list-table::
   :widths: 9 9 9 9 9 9 9 9
   :header-rows: 1

   - 

      - **31**
      - **30**
      - **29**
      - **28**
      - **27**
      - **26**
      - **25**
      - **24**
   - 

      - -
      - 
      - 
      - 
      - 
      - 
      - 
      - 
   - 

      - **23**
      - **22**
      - **21**
      - **20**
      - **19**
      - **18**
      - **17**
      - **16**
   - 

      - -
      - 
      - 
      - 
      - 
      - 
      - 
      - 
   - 

      - **15**
      - **14**
      - **13**
      - **12**
      - **11**
      - **10**
      - **9**
      - **8**
   - 

      - MAXCNT
      - 
      - 
      - 
      - 
      - 
      - 
      - 
   - 

      - **7**
      - **6**
      - **5**
      - **4**
      - **3**
      - **2**
      - **1**
      - **0**
   - 

      - MAXCNT
      - 
      - 
      - 
      - 
      - 
      - 
      - 

.. list-table::
   :widths: 7 15 50
   :header-rows: 1

   - 

      - 位域
      - 名称
      - 描述
   - 

      - 31:6
      - -
      - -
   - 

      - 15:0
      - MAXCNT
      - 位置计数器/定时器匹配计数值

**中断使能寄存器（IE）**
^^^^^^^^^^^^^^^^^^^^^^^^

.. list-table::
   :widths: 12 9 6 12 33
   :header-rows: 1

   - 

      - 寄存器
      - 偏移
      - 类型
      - 复位值
      - 描述
   - 

      - IE
      - 0x20
      - R/W
      - 0x00
      - 中断使能寄存器

.. list-table::
   :widths: 9 9 9 9 9 9 9 9
   :header-rows: 1

   - 

      - **31**
      - **30**
      - **29**
      - **28**
      - **27**
      - **26**
      - **25**
      - **24**
   - 

      - -
      - 
      - 
      - 
      - 
      - 
      - 
      - 
   - 

      - **23**
      - **22**
      - **21**
      - **20**
      - **19**
      - **18**
      - **17**
      - **16**
   - 

      - -
      - 
      - 
      - 
      - 
      - 
      - 
      - 
   - 

      - **15**
      - **14**
      - **13**
      - **12**
      - **11**
      - **10**
      - **9**
      - **8**
   - 

      - -
      - 
      - 
      - 
      - 
      - 
      - 
      - 
   - 

      - **7**
      - **6**
      - **5**
      - **4**
      - **3**
      - **2**
      - **1**
      - **0**
   - 

      - -
      - 
      - 
      - 
      - INTEN3
      - INTEN2
      - INTEN1
      - INTEN0

.. list-table::
   :widths: 7 15 50
   :header-rows: 1

   - 

      - 位域
      - 名称
      - 描述
   - 

      - 31:4
      - REVERSED
      - 保留
   - 

      - 3
      - INTEN3
      - 计数错误中断使能标志位

         1：使能

         0：禁能
   - 

      - 2
      - INTEN2
      - 计数器溢出中断使能标志位

         1：使能

         0：禁能
   - 

      - 1
      - INTEN1
      - 计数匹配/定时器中断使能标志位

         1：使能

         0：禁能
   - 

      - 0
      - INTEN0
      - 索引信号复位中断使能使能标志位

         1：使能

         0：禁能

**中断状态屏蔽寄存器（IM）**
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. list-table::
   :widths: 12 9 6 12 33
   :header-rows: 1

   - 

      - 寄存器
      - 偏移
      - 类型
      - 复位值
      - 描述
   - 

      - IM
      - 0x24
      - R/W
      - 0
      - 中断状态屏蔽寄存器

.. list-table::
   :widths: 9 9 9 9 9 9 9 9
   :header-rows: 1

   - 

      - **31**
      - **30**
      - **29**
      - **28**
      - **27**
      - **26**
      - **25**
      - **24**
   - 

      - -
      - 
      - 
      - 
      - 
      - 
      - 
      - 
   - 

      - **23**
      - **22**
      - **21**
      - **20**
      - **19**
      - **18**
      - **17**
      - **16**
   - 

      - -
      - 
      - 
      - 
      - 
      - 
      - 
      - 
   - 

      - **15**
      - **14**
      - **13**
      - **12**
      - **11**
      - **10**
      - **9**
      - **8**
   - 

      - -
      - 
      - 
      - 
      - 
      - 
      - 
      - 
   - 

      - **7**
      - **6**
      - **5**
      - **4**
      - **3**
      - **2**
      - **1**
      - **0**
   - 

      - -
      - 
      - 
      - -
      - MASK3
      - MASK2
      - MASK1
      - MASK0

.. list-table::
   :widths: 7 15 50
   :header-rows: 1

   - 

      - 位域
      - 名称
      - 描述
   - 

      - 31:4
      - -
      - 
   - 

      - 3
      - MASK3
      - 屏蔽计数错误中断标志位

         1：未屏蔽

         0：已屏蔽
   - 

      - 2
      - MASK2
      - 屏蔽计数器溢出中断标志位

         1：未屏蔽

         0：已屏蔽
   - 

      - 1
      - MASK1
      - 屏蔽计数匹配/定时器中断标志位

         1：未屏蔽

         0：已屏蔽
   - 

      - 0
      - MASK0
      - 屏蔽索引信号复位中断标志位

         1：未屏蔽

         0：已屏蔽

**清除中断状态寄存器（IC）**
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. list-table::
   :widths: 12 9 6 12 33
   :header-rows: 1

   - 

      - 寄存器
      - 偏移
      - 类型
      - 复位值
      - 描述
   - 

      - IC
      - 0x28
      - R/W
      - 0x0
      - 清除中断状态寄存器

.. list-table::
   :widths: 9 9 9 9 9 9 9 9
   :header-rows: 1

   - 

      - **31**
      - **30**
      - **29**
      - **28**
      - **27**
      - **26**
      - **25**
      - **24**
   - 

      - -
      - 
      - 
      - 
      - 
      - 
      - 
      - 
   - 

      - **23**
      - **22**
      - **21**
      - **20**
      - **19**
      - **18**
      - **17**
      - **16**
   - 

      - -
      - 
      - 
      - 
      - 
      - 
      - 
      - 
   - 

      - **15**
      - **14**
      - **13**
      - **12**
      - **11**
      - **10**
      - **9**
      - **8**
   - 

      - -
      - 
      - 
      - 
      - 
      - 
      - 
      - 
   - 

      - **7**
      - **6**
      - **5**
      - **4**
      - **3**
      - **2**
      - **1**
      - **0**
   - 

      - -
      - 
      - 
      - -
      - CLR3
      - CLR2
      - CLR1
      - CLR0

.. list-table::
   :widths: 7 15 50
   :header-rows: 1

   - 

      - 位域
      - 名称
      - 描述
   - 

      - 31:4
      - REVERSED
      - 保留
   - 

      - 3
      - CLR3
      - 清除计数错误中断标志位

         1：清除

         0：未清除
   - 

      - 2
      - CLR2
      - 清除计数器溢出中断标志位

         1：清除

         0：未清除
   - 

      - 1
      - CLR1
      - 清除计数匹配/定时器中断标志位

         1：清除

         0：未清除
   - 

      - 0
      - CLR0
      - 清除索引信号复位中断标志位

         1：清除

         0：未清除

**中断状态寄存器（IF）**
^^^^^^^^^^^^^^^^^^^^^^^^

.. list-table::
   :widths: 12 9 6 12 33
   :header-rows: 1

   - 

      - 寄存器
      - 偏移
      - 类型
      - 复位值
      - 描述
   - 

      - IF
      - 0x2C
      - RO
      - 0
      - 中断状态寄存器

.. list-table::
   :widths: 9 9 9 9 9 9 9 9
   :header-rows: 1

   - 

      - **31**
      - **30**
      - **29**
      - **28**
      - **27**
      - **26**
      - **25**
      - **24**
   - 

      - -
      - 
      - 
      - 
      - 
      - 
      - 
      - 
   - 

      - **23**
      - **22**
      - **21**
      - **20**
      - **19**
      - **18**
      - **17**
      - **16**
   - 

      - -
      - 
      - 
      - 
      - 
      - 
      - 
      - 
   - 

      - **15**
      - **14**
      - **13**
      - **12**
      - **11**
      - **10**
      - **9**
      - **8**
   - 

      - -
      - 
      - 
      - 
      - 
      - 
      - 
      - 
   - 

      - **7**
      - **6**
      - **5**
      - **4**
      - **3**
      - **2**
      - **1**
      - **0**
   - 

      - -
      - 
      - 
      - -
      - INT3
      - INT2
      - INT1
      - INT0

.. list-table::
   :widths: 7 15 50
   :header-rows: 1

   - 

      - 位域
      - 名称
      - 描述
   - 

      - 31:4
      - REVERSED
      - 保留
   - 

      - 3
      - INT3
      - 计数错误中断标志位

         1: 有错误

         0：无错误
   - 

      - 2
      - INT2
      - 计数器溢出中断标志位

         1：以溢出

         0：未溢出
   - 

      - 1
      - INT1
      - 计数匹配/定时器中断标志位

         1：计数匹配

         0：计数未匹配
   - 

      - 0
      - INT0
      - 索引信号复位中断标志位

         1：以复位

         0：未复位

**中断溢出寄存器（IFOV）**
^^^^^^^^^^^^^^^^^^^^^^^^^^

.. list-table::
   :widths: 12 9 6 12 33
   :header-rows: 1

   - 

      - 寄存器
      - 偏移
      - 类型
      - 复位值
      - 描述
   - 

      - IFOV
      - 0x30
      - RO
      - 0
      - 中断溢出寄存器

.. list-table::
   :widths: 9 9 9 9 9 9 9 9
   :header-rows: 1

   - 

      - **31**
      - **30**
      - **29**
      - **28**
      - **27**
      - **26**
      - **25**
      - **24**
   - 

      - -
      - 
      - 
      - 
      - 
      - 
      - 
      - 
   - 

      - **23**
      - **22**
      - **21**
      - **20**
      - **19**
      - **18**
      - **17**
      - **16**
   - 

      - -
      - 
      - 
      - 
      - 
      - 
      - 
      - 
   - 

      - **15**
      - **14**
      - **13**
      - **12**
      - **11**
      - **10**
      - **9**
      - **8**
   - 

      - -
      - 
      - 
      - 
      - 
      - 
      - 
      - 
   - 

      - **7**
      - **6**
      - **5**
      - **4**
      - **3**
      - **2**
      - **1**
      - **0**
   - 

      - -
      - 
      - 
      - 
      - FLINT3
      - FLINT2
      - FLINT1
      - FLINT0

.. list-table::
   :widths: 7 15 50
   :header-rows: 1

   - 

      - 位域
      - 名称
      - 描述
   - 

      - 31:4
      - REVERSED
      - 保留
   - 

      - 3
      - FLINT3
      - 计数错误中断溢出标志位

         1：溢出

         0：未溢出
   - 

      - 2
      - FLINT2
      - 计数器溢出中断溢出标志位

         1：溢出

         0：未溢出
   - 

      - 1
      - FLINT1
      - 计数匹配/定时器中断溢出标志位

         1：溢出

         0：未溢出
   - 

      - 0
      - FLINT0
      - 索引信号复位中断溢出标志位

         1：溢出

         0：未溢出

.. |image1| image:: media/image1.emf
   :width: 5.87361in
   :height: 2.96875in
.. |image2| image:: media/image2.emf
   :width: 2.36458in
   :height: 1.75in
.. |image3| image:: media/image3.emf
   :width: 4.55625in
   :height: 3.83194in
.. |image4| image:: media/image4.emf
   :width: 5.76389in
   :height: 2.65972in
.. |image5| image:: media/image5.emf
   :width: 5.76389in
   :height: 2.40278in
.. |image6| image:: media/image6.emf
   :width: 5.5in
   :height: 1.9in
.. |image7| image:: media/image7.emf
   :width: 5.35139in
   :height: 2.65278in
